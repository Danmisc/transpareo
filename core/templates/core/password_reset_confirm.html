{% extends 'core/auth_base.html' %}

{% block title %}Nouveau mot de passe - Transpareo{% endblock %}

{% block extra_css %}
<style>
    .password-strength {
        margin-top: 8px;
        height: 4px;
        background: #e5e5e5;
        border-radius: 2px;
        overflow: hidden;
        display: none;
    }
    
    .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: all 0.3s;
        border-radius: 2px;
    }
    
    .strength-weak { background: #dc3545; width: 33%; }
    .strength-medium { background: #ffc107; width: 66%; }
    .strength-strong { background: #28a745; width: 100%; }
    
    .real-time-feedback {
        font-size: 12px;
        margin-top: 6px;
        min-height: 18px;
    }
    
    .feedback-success {
        color: #28a745;
    }
    
    .feedback-error {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-form">
    <h1>Nouveau mot de passe</h1>
    <p class="subtitle">Choisissez un nouveau mot de passe sécurisé</p>

    <form method="post" novalidate id="reset-form">
        {% csrf_token %}
        
        <!-- New Password -->
        <div class="form-group">
            <label for="{{ form.password1.id_for_label }}">Nouveau mot de passe</label>
            <div class="input-wrapper">
                {{ form.password1 }}
                <button type="button" class="password-toggle" onclick="togglePassword('{{ form.password1.id_for_label }}')">
                    <svg id="eye-{{ form.password1.id_for_label }}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>
            <div class="password-strength">
                <div class="password-strength-bar"></div>
            </div>
            <div class="help-text">
                Minimum 8 caractères avec au moins une majuscule, une minuscule, un chiffre et un caractère spécial
            </div>
            {% if form.password1.errors %}
                <ul class="errorlist">
                    {% for error in form.password1.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        
        <!-- Confirm Password -->
        <div class="form-group">
            <label for="{{ form.password2.id_for_label }}">Confirmer le mot de passe</label>
            <div class="input-wrapper">
                {{ form.password2 }}
                <button type="button" class="password-toggle" onclick="togglePassword('{{ form.password2.id_for_label }}')">
                    <svg id="eye-{{ form.password2.id_for_label }}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>
            <div class="real-time-feedback" id="password-match-feedback"></div>
            {% if form.password2.errors %}
                <ul class="errorlist">
                    {% for error in form.password2.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        
        {% if form.non_field_errors %}
            <ul class="errorlist">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        
        <!-- Submit -->
        <button type="submit" class="btn" id="submit-btn">
            <span id="submit-text">Réinitialiser le mot de passe</span>
            <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
        </button>
    </form>

    <div class="auth-links">
        <a href="{% url 'login' %}">← Retour à la connexion</a>
    </div>
</div>

<script>
// Password strength indicator
const passwordInput = document.getElementById('{{ form.password1.id_for_label }}');
const confirmPasswordInput = document.getElementById('{{ form.password2.id_for_label }}');
const strengthBar = document.querySelector('.password-strength-bar');
const strengthContainer = document.querySelector('.password-strength');

if (passwordInput) {
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        
        if (password.length === 0) {
            strengthContainer.style.display = 'none';
            return;
        }
        
        strengthContainer.style.display = 'block';
        
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
        
        const strengthValue = strength / 5;
        strengthBar.style.width = (strengthValue * 100) + '%';
        strengthBar.className = 'password-strength-bar';
        
        if (strengthValue < 0.4) {
            strengthBar.classList.add('strength-weak');
        } else if (strengthValue < 0.7) {
            strengthBar.classList.add('strength-medium');
        } else {
            strengthBar.classList.add('strength-strong');
        }
    });
}

if (confirmPasswordInput) {
    confirmPasswordInput.addEventListener('input', function() {
        const password = passwordInput.value;
        const confirm = this.value;
        const feedback = document.getElementById('password-match-feedback');
        
        if (confirm.length === 0) {
            feedback.innerHTML = '';
            return;
        }
        
        if (password === confirm) {
            feedback.innerHTML = '<span class="feedback-success">✓ Les mots de passe correspondent</span>';
        } else {
            feedback.innerHTML = '<span class="feedback-error">Les mots de passe ne correspondent pas</span>';
        }
    });
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const eye = document.getElementById('eye-' + inputId);
    
    if (input.type === 'password') {
        input.type = 'text';
        eye.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
    } else {
        input.type = 'password';
        eye.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
    }
}

// Loading state
document.getElementById('reset-form').addEventListener('submit', function() {
    const btn = document.getElementById('submit-btn');
    const text = document.getElementById('submit-text');
    const spinner = document.getElementById('loading-spinner');
    
    btn.disabled = true;
    text.style.display = 'none';
    spinner.style.display = 'inline-block';
});
</script>
{% endblock %}
