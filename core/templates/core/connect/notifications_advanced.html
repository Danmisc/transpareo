{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="notifications-center-container">
    <!-- Header -->
    <div class="notifications-header">
        <div class="header-left">
            <h1>üîî Centre de notifications</h1>
            <p class="header-subtitle">Timeline de toutes vos actions cross-produits</p>
        </div>
        <div class="header-right">
            <div class="header-stats">
                <div class="stat-badge total">
                    <span class="stat-label">Total</span>
                    <span class="stat-value">{{ total_count }}</span>
                </div>
                <div class="stat-badge unread">
                    <span class="stat-label">Non lues</span>
                    <span class="stat-value">{{ unread_count }}</span>
                </div>
            </div>
            <div class="header-actions">
                {% if unread_count > 0 %}
                <button class="btn-mark-all-read" onclick="markAllAsRead()">
                    ‚úì Tout marquer comme lu
                </button>
                {% endif %}
                <a href="{% url 'connect-notification-settings' %}" class="btn-settings">
                    ‚öôÔ∏è Param√®tres
                </a>
            </div>
        </div>
    </div>

    <!-- Barre de recherche -->
    <div class="search-bar-section">
        <form method="GET" action="{% url 'connect-notifications' %}" class="search-form">
            <input 
                type="text" 
                name="q" 
                value="{{ search_query }}" 
                placeholder="Rechercher dans les notifications..." 
                class="search-input"
            >
            <button type="submit" class="search-btn">üîç</button>
        </form>
    </div>

    <!-- Filtres -->
    <div class="filters-section">
        <div class="filters-tabs">
            <!-- Filtres par cat√©gorie -->
            <div class="filter-group">
                <label>Cat√©gorie</label>
                <div class="filter-buttons">
                    <button 
                        class="filter-btn {% if filter_category == 'all' %}active{% endif %}" 
                        onclick="applyFilter('category', 'all')"
                    >
                        Toutes ({{ total_count }})
                    </button>
                    {% for cat in category_counts %}
                    <button 
                        class="filter-btn {% if filter_category == cat.code %}active{% endif %}" 
                        onclick="applyFilter('category', '{{ cat.code }}')"
                    >
                        {{ cat.label }} 
                        {% if cat.count %}
                            ({{ cat.count }})
                        {% endif %}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Filtres par importance -->
            <div class="filter-group">
                <label>Importance</label>
                <div class="filter-buttons">
                    <button 
                        class="filter-btn {% if filter_importance == 'all' %}active{% endif %}" 
                        onclick="applyFilter('importance', 'all')"
                    >
                        Toutes
                    </button>
                    {% for imp in importance_counts %}
                    <button 
                        class="filter-btn importance-{{ imp.code }} {% if filter_importance == imp.code %}active{% endif %}" 
                        onclick="applyFilter('importance', '{{ imp.code }}')"
                    >
                        {% if imp.code == 'critical' %}üî¥{% elif imp.code == 'high' %}üü†{% elif imp.code == 'medium' %}üü°{% else %}‚ö™{% endif %}
                        {{ imp.label }} ({{ imp.count }})
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Filtres par statut -->
            <div class="filter-group">
                <label>Statut</label>
                <div class="filter-buttons">
                    <button 
                        class="filter-btn {% if filter_read == 'all' %}active{% endif %}" 
                        onclick="applyFilter('read', 'all')"
                    >
                        Toutes
                    </button>
                    <button 
                        class="filter-btn {% if filter_read == 'unread' %}active{% endif %}" 
                        onclick="applyFilter('read', 'unread')"
                    >
                        Non lues ({{ unread_count }})
                    </button>
                    <button 
                        class="filter-btn {% if filter_read == 'read' %}active{% endif %}" 
                        onclick="applyFilter('read', 'read')"
                    >
                        Lues
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline des notifications -->
    <div class="notifications-timeline" id="notifications-timeline">
        {% for notification in notifications %}
        <div class="notification-item 
                    {% if not notification.read %}unread{% endif %} 
                    importance-{{ notification.importance }} 
                    category-{{ notification.category }}"
             data-notification-id="{{ notification.id }}">
            <div class="notification-icon">
                {{ notification.icon|default:"üîî" }}
            </div>
            <div class="notification-content">
                <div class="notification-header">
                    <h4 class="notification-title">{{ notification.title }}</h4>
                    <div class="notification-badges">
                        <span class="badge-category">{{ notification.get_category_display }}</span>
                        <span class="badge-importance importance-{{ notification.importance }}">
                            {{ notification.get_importance_display }}
                        </span>
                    </div>
                </div>
                <p class="notification-message">{{ notification.message }}</p>
                <div class="notification-meta">
                    {% if notification.from_user %}
                    <span class="meta-from">
                        De: <a href="{% url 'profile-user' notification.from_user.id %}">{{ notification.from_user.username }}</a>
                    </span>
                    {% endif %}
                    <span class="meta-time">{{ notification.created_at|naturaltime }}</span>
                </div>
                {% if notification.action_url %}
                <a href="{{ notification.action_url }}" class="notification-action-link">Voir ‚Üí</a>
                {% endif %}
            </div>
            <div class="notification-actions">
                {% if not notification.read %}
                <button class="btn-mark-read" onclick="markAsRead({{ notification.id }})" title="Marquer comme lu">
                    ‚úì
                </button>
                {% endif %}
                <button class="btn-not-interested" onclick="markNotInterested({{ notification.id }})" title="Pas int√©ressant">
                    ‚úï
                </button>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <p>Aucune notification trouv√©e.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if notifications.has_other_pages %}
    <div class="pagination">
        {% if notifications.has_previous %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ notifications.previous_page_number }}" class="page-link">‚Üê Pr√©c√©dent</a>
        {% endif %}
        <span class="page-info">Page {{ notifications.number }} sur {{ notifications.paginator.num_pages }}</span>
        {% if notifications.has_next %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ notifications.next_page_number }}" class="page-link">Suivant ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Toast container pour notifications push -->
<div id="toast-container" class="toast-container"></div>

<style>
/* Styles pour le centre de notifications */
.notifications-center-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px;
}

.notifications-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 2px solid #e0e0e0;
}

.header-left h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
}

.header-subtitle {
    color: #666;
    font-size: 14px;
    margin: 0;
}

.header-right {
    display: flex;
    gap: 24px;
    align-items: center;
}

.header-stats {
    display: flex;
    gap: 12px;
}

.stat-badge {
    padding: 8px 16px;
    border-radius: 8px;
    background: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-badge.unread {
    background: #fff3cd;
    border: 2px solid #ffc107;
}

.stat-label {
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    font-weight: 600;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a1a;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.btn-mark-all-read, .btn-settings {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-mark-all-read {
    background: #D3580B;
    color: white;
}

.btn-settings {
    background: #f5f5f5;
    color: #333;
}

.search-bar-section {
    margin-bottom: 24px;
}

.search-form {
    display: flex;
    gap: 12px;
    max-width: 600px;
}

.search-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
}

.search-btn {
    padding: 12px 24px;
    background: #D3580B;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
}

.filters-section {
    margin-bottom: 32px;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 12px;
}

.filter-group {
    margin-bottom: 20px;
}

.filter-group:last-child {
    margin-bottom: 0;
}

.filter-group label {
    display: block;
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 14px;
    color: #333;
}

.filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.filter-btn {
    padding: 8px 16px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-btn:hover {
    border-color: #D3580B;
}

.filter-btn.active {
    background: #D3580B;
    color: white;
    border-color: #D3580B;
}

.filter-btn.importance-critical.active {
    background: #f44336;
    border-color: #f44336;
}

.filter-btn.importance-high.active {
    background: #ff9800;
    border-color: #ff9800;
}

.filter-btn.importance-medium.active {
    background: #ffc107;
    border-color: #ffc107;
    color: #333;
}

.filter-btn.importance-low.active {
    background: #9e9e9e;
    border-color: #9e9e9e;
}

.notifications-timeline {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.notification-item {
    display: flex;
    gap: 16px;
    padding: 20px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    transition: all 0.2s;
    position: relative;
}

.notification-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.notification-item.unread {
    border-left: 4px solid #D3580B;
    background: #fff9f0;
}

.notification-item.importance-critical {
    border-left-color: #f44336;
}

.notification-item.importance-high {
    border-left-color: #ff9800;
}

.notification-item.importance-medium {
    border-left-color: #ffc107;
}

.notification-item.importance-low {
    border-left-color: #9e9e9e;
}

.notification-icon {
    font-size: 32px;
    flex-shrink: 0;
}

.notification-content {
    flex: 1;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.notification-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.notification-badges {
    display: flex;
    gap: 8px;
}

.badge-category, .badge-importance {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.badge-category {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-importance.importance-critical {
    background: #ffebee;
    color: #c62828;
}

.badge-importance.importance-high {
    background: #fff3e0;
    color: #e65100;
}

.badge-importance.importance-medium {
    background: #fffde7;
    color: #f57f17;
}

.badge-importance.importance-low {
    background: #f5f5f5;
    color: #616161;
}

.notification-message {
    margin: 8px 0;
    color: #666;
    line-height: 1.6;
}

.notification-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: #999;
    margin-top: 8px;
}

.notification-action-link {
    display: inline-block;
    margin-top: 12px;
    color: #D3580B;
    font-weight: 600;
    text-decoration: none;
}

.notification-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn-mark-read, .btn-not-interested {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-mark-read {
    background: #4caf50;
    color: white;
}

.btn-mark-read:hover {
    background: #45a049;
}

.btn-not-interested {
    background: #f5f5f5;
    color: #666;
}

.btn-not-interested:hover {
    background: #e0e0e0;
}

/* Toast container */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.toast {
    padding: 16px 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 300px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast.success {
    border-left: 4px solid #4caf50;
}

.toast.error {
    border-left: 4px solid #f44336;
}

.toast.info {
    border-left: 4px solid #2196f3;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-top: 32px;
}

.page-link {
    padding: 8px 16px;
    background: #D3580B;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}
</style>

<script>
// Fonctions JavaScript
function applyFilter(filterName, filterValue) {
    const url = new URL(window.location.href);
    if (filterValue && filterValue !== 'all') {
        url.searchParams.set(filterName, filterValue);
    } else {
        url.searchParams.delete(filterName);
    }
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

function markAsRead(notificationId) {
    fetch(`{% url 'api-mark-notification-read' notification_id=0 %}`.replace('0', notificationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (item) {
                item.classList.remove('unread');
                item.querySelector('.btn-mark-read')?.remove();
            }
            showToast('Notification marqu√©e comme lue', 'success');
        }
    });
}

function markAllAsRead() {
    if (confirm('Marquer toutes les notifications comme lues ?')) {
        fetch('{% url "mark-all-notifications-read" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function markNotInterested(notificationId) {
    if (confirm('Marquer cette notification comme "pas int√©ressante" ? Cela aidera √† am√©liorer vos suggestions.')) {
        fetch(`{% url 'api-mark-notification-not-interested' notification_id=0 %}`.replace('0', notificationId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (item) {
                    item.style.opacity = '0.5';
                    item.style.textDecoration = 'line-through';
                }
                showToast('Feedback enregistr√©. Merci !', 'info');
            }
        });
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Syst√®me de push notifications (toast + navigateur)
let notificationCheckInterval;

function initPushNotifications() {
    // Demander permission pour les notifications push navigateur
    if ('Notification' in window && Notification.permission === 'default') {
        // Optionnel: demander la permission
        // Notification.requestPermission();
    }
    
    // V√©rifier les nouvelles notifications toutes les 30 secondes
    {% if preferences.enable_toast or preferences.enable_push %}
    checkNewNotifications();
    notificationCheckInterval = setInterval(checkNewNotifications, 30000); // Toutes les 30 secondes
    {% endif %}
}

function checkNewNotifications() {
    fetch('{% url "api-get-notifications-realtime" %}')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.notifications.length > 0) {
                data.notifications.forEach(notif => {
                    // Toast notification
                    {% if preferences.enable_toast %}
                    showToast(`${notif.icon} ${notif.title}`, 'info');
                    {% endif %}
                    
                    // Push notification navigateur
                    {% if preferences.enable_push %}
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification(notif.title, {
                            body: notif.message,
                            icon: '/static/core/img/logo.png',
                            badge: '/static/core/img/logo.png',
                            tag: `notif-${notif.id}`,
                            requireInteraction: notif.importance === 'critical',
                        }).onclick = function() {
                            window.focus();
                            if (notif.action_url) {
                                window.location.href = notif.action_url;
                            }
                        };
                    }
                    {% endif %}
                });
            }
        })
        .catch(err => console.error('Erreur v√©rification notifications:', err));
}

// Initialiser au chargement
document.addEventListener('DOMContentLoaded', function() {
    initPushNotifications();
});

// Nettoyer l'intervalle √† la fermeture
window.addEventListener('beforeunload', function() {
    if (notificationCheckInterval) {
        clearInterval(notificationCheckInterval);
    }
});
</script>
{% endblock %}

