{% load static %}
{% load humanize %}
{% load core_filters %}

<div class="post-card" data-post-id="{{ post.id }}">
    <!-- Header Post -->
    <div class="post-header">
        <div class="post-author">
            {% if post.author.avatar %}
            <img src="{{ post.author.avatar.url }}" alt="{{ post.author.username }}" class="post-avatar">
            {% else %}
            <div class="post-avatar placeholder">{{ post.author.username|first|upper }}</div>
            {% endif %}
            <div class="post-author-info">
                <a href="{% url 'profile-user' post.author.id %}" class="post-author-name">
                    {{ post.author.get_full_name|default:post.author.username }}
                </a>
                {% if post.author.identity_verified or post.author.proprietaire_verified %}
                <span class="verified-badge" title="VÃ©rifiÃ©">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </span>
                {% endif %}
                <p class="post-author-title">{{ post.author.profession|default:"" }}</p>
                <span class="post-timestamp">{{ post.created_at|timesince }}</span>
            </div>
        </div>
        <div class="post-visibility">
            {% if post.visibility == 'public' %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
            {% elif post.visibility == 'group' %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            {% else %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            {% endif %}
        </div>
        <div class="post-actions-menu">
            <button class="post-menu-btn" onclick="togglePostMenu({{ post.id }})">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </button>
            <div class="post-menu-dropdown" id="post-menu-{{ post.id }}" style="display: none;">
                <a href="#" class="menu-item" onclick="savePost({{ post.id }})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Sauvegarder post
                </a>
                <a href="#" class="menu-item" onclick="copyPostLink({{ post.id }})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copier lien post
                </a>
                <a href="#" class="menu-item" onclick="sharePostInMessage({{ post.id }})">Partager dans message</a>
                {% if post.author.id != user.id %}
                <div class="menu-divider"></div>
                <a href="#" class="menu-item" onclick="reportPost({{ post.id }})">Signaler contenu inappropriÃ©</a>
                <a href="#" class="menu-item" onclick="hidePost({{ post.id }})">Masquer post</a>
                <a href="#" class="menu-item" onclick="unfollowUser({{ post.author.id }})">Ne plus suivre {{ post.author.username }}</a>
                {% else %}
                <div class="menu-divider"></div>
                <a href="#" class="menu-item" onclick="editPost({{ post.id }})">Modifier</a>
                <a href="#" class="menu-item menu-danger" onclick="deletePost({{ post.id }})">Supprimer</a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Corps Post -->
    <div class="post-content">
        <p class="post-text">{{ post.content|linebreaks }}</p>
        {% if post.hashtags %}
        <div class="post-hashtags">
            {% for tag in post.hashtags|split:"," %}
            <a href="#" class="hashtag-link">#{{ tag|trim }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- MÃ©dias Post -->
    {% if post.post_images_rel.exists %}
    <div class="post-media">
        {% with images=post.post_images_rel.all %}
        {% if images|length == 1 %}
        <div class="post-media-single">
            <img src="{{ images.0.image.url }}" alt="Post image" onclick="openImageLightbox({{ post.id }}, 0)">
        </div>
        {% elif images|length == 2 %}
        <div class="post-media-double">
            <img src="{{ images.0.image.url }}" alt="Post image" onclick="openImageLightbox({{ post.id }}, 0)">
            <img src="{{ images.1.image.url }}" alt="Post image" onclick="openImageLightbox({{ post.id }}, 1)">
        </div>
        {% else %}
        <div class="post-media-grid">
            {% for image in images|slice:":4" %}
            <div class="post-media-item {% if forloop.counter == 4 and images|length > 4 %}has-more{% endif %}">
                <img src="{{ image.image.url }}" alt="Post image" onclick="openImageLightbox({{ post.id }}, {{ forloop.counter0 }})">
                {% if forloop.counter == 4 and images|length > 4 %}
                <div class="media-more-overlay">+{{ images|length|add:"-4" }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
    </div>
    {% endif %}
    
    <!-- Footer Post -->
    <div class="post-footer">
        <div class="post-metrics">
            <span class="metric-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                {{ post.likes_count|default:0 }}
            </span>
            <span class="metric-separator">|</span>
            <span class="metric-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                {{ post.comments_count|default:0 }}
            </span>
            <span class="metric-separator">|</span>
            <span class="metric-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="17 1 21 5 17 9"></polyline>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                    <polyline points="7 23 3 19 7 15"></polyline>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                </svg>
                {{ post.shares_count|default:0 }}
            </span>
        </div>
        <div class="post-actions">
            <button class="post-action-btn like-btn {% if post.id in user_liked_posts %}liked{% endif %}" 
                    onclick="toggleLike({{ post.id }})">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <span>J'aime</span>
            </button>
            <button class="post-action-btn" onclick="focusComments({{ post.id }})">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>Commenter</span>
            </button>
            <button class="post-action-btn" onclick="sharePost({{ post.id }})">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="17 1 21 5 17 9"></polyline>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                    <polyline points="7 23 3 19 7 15"></polyline>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                </svg>
                <span>Partager</span>
            </button>
            <button class="post-action-btn" onclick="sendPost({{ post.id }})">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                <span>Envoyer</span>
            </button>
        </div>
        
        <!-- Section Commentaires -->
        <div class="post-comments" id="comments-{{ post.id }}">
            <div class="comments-list">
                {% for comment in post.comments.all|slice:":3" %}
                <div class="comment-item">
                    {% if comment.author.avatar %}
                    <img src="{{ comment.author.avatar.url }}" alt="{{ comment.author.username }}" class="comment-avatar">
                    {% else %}
                    <div class="comment-avatar placeholder">{{ comment.author.username|first|upper }}</div>
                    {% endif %}
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="{% url 'profile-user' comment.author.id %}" class="comment-author">{{ comment.author.username }}</a>
                            <span class="comment-time">{{ comment.created_at|timesince }}</span>
                        </div>
                        <p class="comment-text">{{ comment.content }}</p>
                        <div class="comment-actions">
                            <button class="comment-like-btn" onclick="toggleCommentLike({{ comment.id }})">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                {{ comment.likes_count|default:0 }}
                            </button>
                            <button class="comment-reply-btn" onclick="replyToComment({{ comment.id }})">RÃ©pondre</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if post.comments_count > 3 %}
                <button class="view-all-comments" onclick="viewAllComments({{ post.id }})">
                    Voir tous les commentaires ({{ post.comments_count }})
                </button>
                {% endif %}
            </div>
            <div class="add-comment">
                {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="comment-avatar">
                {% else %}
                <div class="comment-avatar placeholder">{{ user.username|first|upper }}</div>
                {% endif %}
                <div class="comment-input-wrapper">
                    <input type="text" 
                           class="comment-input" 
                           placeholder="Ajouter un commentaire..."
                           onkeypress="handleCommentKeypress(event, {{ post.id }})">
                    <div class="comment-input-actions">
                        <button class="emoji-picker-btn" onclick="openEmojiPicker({{ post.id }})">ðŸ˜Š</button>
                        <button class="mention-btn" onclick="openMentionPicker({{ post.id }})">@</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


