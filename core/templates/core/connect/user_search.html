{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="user-search-container">
    <!-- Header -->
    <div class="search-header">
        <h1>üîç Recherche d'utilisateurs</h1>
        <p class="search-subtitle">Trouvez des locataires, propri√©taires ou collaborateurs</p>
    </div>

    <!-- Barre de recherche principale -->
    <div class="search-bar-main">
        <form method="GET" action="{% url 'connect-user-search' %}" id="search-form">
            <div class="search-input-wrapper">
                <input 
                    type="text" 
                    name="q" 
                    value="{{ search_query }}" 
                    placeholder="Rechercher par nom, username, ville, profession..." 
                    class="search-input"
                    id="search-input"
                >
                <button type="submit" class="search-btn">üîç Rechercher</button>
            </div>
        </form>
    </div>

    <!-- Filtres intelligents pr√©-s√©lectionn√©s -->
    <div class="smart-filters-section">
        <h3>Filtres intelligents</h3>
        <div class="smart-filters-grid">
            <button 
                class="smart-filter-btn {% if filter_type == 'all' %}active{% endif %}" 
                data-filter="all"
                onclick="applyFilter('filter_type', 'all')"
            >
                <span class="filter-icon">üë•</span>
                <span class="filter-label">Tous</span>
                <span class="filter-count">({{ stats_filtres.total_users }})</span>
            </button>
            <button 
                class="smart-filter-btn {% if filter_type == 'locataires' %}active{% endif %}" 
                data-filter="locataires"
                onclick="applyFilter('filter_type', 'locataires')"
            >
                <span class="filter-icon">üè†</span>
                <span class="filter-label">Locataires</span>
                <span class="filter-count">({{ stats_filtres.locataires_count }})</span>
            </button>
            <button 
                class="smart-filter-btn {% if filter_type == 'proprietaires' %}active{% endif %}" 
                data-filter="proprietaires"
                onclick="applyFilter('filter_type', 'proprietaires')"
            >
                <span class="filter-icon">üîë</span>
                <span class="filter-label">Propri√©taires</span>
                <span class="filter-count">({{ stats_filtres.proprietaires_count }})</span>
            </button>
            <button 
                class="smart-filter-btn {% if filter_type == 'proches' %}active{% endif %}" 
                data-filter="proches"
                onclick="applyFilter('filter_type', 'proches')"
            >
                <span class="filter-icon">üìç</span>
                <span class="filter-label">Utilisateurs proches</span>
                <span class="filter-count">({{ stats_filtres.proches_count }})</span>
            </button>
            <button 
                class="smart-filter-btn {% if filter_type == 'similaires' %}active{% endif %}" 
                data-filter="similaires"
                onclick="applyFilter('filter_type', 'similaires')"
            >
                <span class="filter-icon">üéØ</span>
                <span class="filter-label">Profils similaires</span>
            </button>
            <button 
                class="smart-filter-btn {% if filter_type == 'quartier' %}active{% endif %}" 
                data-filter="quartier"
                onclick="applyFilter('filter_type', 'quartier')"
            >
                <span class="filter-icon">üèòÔ∏è</span>
                <span class="filter-label">Sp√©cialis√©s dans X quartier</span>
            </button>
        </div>
    </div>

    <!-- Filtres avanc√©s -->
    <div class="advanced-filters-section">
        <button class="toggle-filters-btn" onclick="toggleAdvancedFilters()">
            <span>‚öôÔ∏è Filtres avanc√©s</span>
            <span class="toggle-icon">‚ñº</span>
        </button>
        <div class="advanced-filters-content" id="advanced-filters" style="display: none;">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Ville</label>
                    <input type="text" name="filter_ville" value="{{ filter_ville }}" placeholder="Ex: Toulouse" onchange="applyFilter('filter_ville', this.value)">
                </div>
                <div class="filter-group">
                    <label>R√©gion</label>
                    <input type="text" name="filter_region" value="{{ filter_region }}" placeholder="Ex: Occitanie" onchange="applyFilter('filter_region', this.value)">
                </div>
                <div class="filter-group">
                    <label>Recherche logement</label>
                    <select name="recherche_logement" onchange="applyFilter('recherche_logement', this.value)">
                        <option value="">Tous</option>
                        <option value="active" {% if filter_recherche_logement == 'active' %}selected{% endif %}>Recherche active</option>
                        <option value="passive" {% if filter_recherche_logement == 'passive' %}selected{% endif %}>Recherche passive</option>
                        <option value="none" {% if filter_recherche_logement == 'none' %}selected{% endif %}>Ne recherche pas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Recherche locataire</label>
                    <select name="recherche_locataire" onchange="applyFilter('recherche_locataire', this.value)">
                        <option value="">Tous</option>
                        <option value="active" {% if filter_recherche_locataire == 'active' %}selected{% endif %}>Recherche active</option>
                        <option value="passive" {% if filter_recherche_locataire == 'passive' %}selected{% endif %}>Recherche passive</option>
                        <option value="none" {% if filter_recherche_locataire == 'none' %}selected{% endif %}>Ne recherche pas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Disponibilit√© RDV</label>
                    <select name="disponibilite" onchange="applyFilter('disponibilite', this.value)">
                        <option value="">Tous</option>
                        <option value="disponible" {% if filter_disponibilite == 'disponible' %}selected{% endif %}>Disponible</option>
                        <option value="occupe" {% if filter_disponibilite == 'occupe' %}selected{% endif %}>Occup√©</option>
                        <option value="bientot_disponible" {% if filter_disponibilite == 'bientot_disponible' %}selected{% endif %}>Bient√¥t disponible</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Trier par</label>
                    <select name="sort" onchange="applyFilter('sort', this.value)">
                        <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Pertinence</option>
                        <option value="recent" {% if sort_by == 'recent' %}selected{% endif %}>Plus r√©cents</option>
                        <option value="connections" {% if sort_by == 'connections' %}selected{% endif %}>Plus de connexions</option>
                        <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>Mieux not√©s</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions IA -->
    {% if suggestions_ia %}
    <div class="suggestions-ia-section">
        <h3>ü§ñ Suggestions IA pour vous</h3>
        <div class="suggestions-list">
            {% for suggestion in suggestions_ia %}
            <div class="suggestion-card" data-user-id="{{ suggestion.utilisateur_suggere.id }}">
                <div class="suggestion-header">
                    <div class="suggestion-user-avatar" 
                         onmouseenter="showProfilePopup(event, {{ suggestion.utilisateur_suggere.id }})"
                         onmouseleave="hideProfilePopup()">
                        {% if suggestion.utilisateur_suggere.avatar %}
                            <img src="{{ suggestion.utilisateur_suggere.avatar.url }}" alt="{{ suggestion.utilisateur_suggere.username }}">
                        {% else %}
                            <div class="avatar-placeholder">{{ suggestion.utilisateur_suggere.username|first|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="suggestion-info">
                        <h4>
                            <a href="{% url 'profile-user' suggestion.utilisateur_suggere.id %}">
                                {{ suggestion.utilisateur_suggere.get_full_name|default:suggestion.utilisateur_suggere.username }}
                            </a>
                        </h4>
                        <p class="suggestion-type">{{ suggestion.get_type_suggestion_display }}</p>
                        <p class="suggestion-score">Score: {{ suggestion.score_similarite|floatformat:1 }}%</p>
                    </div>
                </div>
                <div class="suggestion-reasons">
                    <strong>Pourquoi cette suggestion ?</strong>
                    <ul>
                        {% for raison in suggestion.raisons %}
                        <li>{{ raison }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="suggestion-actions">
                    <button class="btn-invite" onclick="openInviteModal({{ suggestion.utilisateur_suggere.id }}, '{{ suggestion.utilisateur_suggere.username }}')">
                        ‚úâÔ∏è Inviter
                    </button>
                    <button class="btn-connect" onclick="sendConnectionRequest({{ suggestion.utilisateur_suggere.id }})">
                        ü§ù Se connecter
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- R√©sultats -->
    <div class="results-section">
        <h3>R√©sultats ({{ page_obj.paginator.count }})</h3>
        <div class="results-grid" id="results-grid">
            {% for user_data in users_data %}
            <div class="user-card" 
                 data-user-id="{{ user_data.user.id }}"
                 onmouseenter="showProfilePopup(event, {{ user_data.user.id }})"
                 onmouseleave="hideProfilePopup()">
                <div class="user-card-header">
                    <div class="user-avatar">
                        {% if user_data.user.avatar %}
                            <img src="{{ user_data.user.avatar.url }}" alt="{{ user_data.user.username }}">
                        {% else %}
                            <div class="avatar-placeholder">{{ user_data.user.username|first|upper }}</div>
                        {% endif %}
                        {% if user_data.user.afficher_statut_online %}
                            <span class="online-status {% if user_data.user.last_activity|timesince|slice:':1'|add:'0' < 5 %}online{% else %}offline{% endif %}"></span>
                        {% endif %}
                    </div>
                    <div class="user-badges">
                        {% if user_data.user.proprietaire_verified %}
                            <span class="badge verified">‚úì V√©rifi√©</span>
                        {% endif %}
                        {% if user_data.user.identity_verified %}
                            <span class="badge identity">üÜî Identit√© v√©rifi√©e</span>
                        {% endif %}
                    </div>
                </div>
                <div class="user-card-body">
                    <h4>
                        <a href="{% url 'profile-user' user_data.user.id %}">
                            {{ user_data.user.get_full_name|default:user_data.user.username }}
                        </a>
                    </h4>
                    <p class="user-username">@{{ user_data.user.username }}</p>
                    {% if user_data.user.profession %}
                    <p class="user-profession">{{ user_data.user.profession }}</p>
                    {% endif %}
                    {% if user_data.user.ville %}
                    <p class="user-location">üìç {{ user_data.user.ville }}{% if user_data.user.region %}, {{ user_data.user.region }}{% endif %}</p>
                    {% endif %}
                    
                    <!-- Statuts de visibilit√© -->
                    <div class="user-status-badges">
                        {% if user_data.user.recherche_logement_status == 'active' %}
                            <span class="status-badge active-search">üîç Recherche logement ACTIVE</span>
                        {% elif user_data.user.recherche_logement_status == 'passive' %}
                            <span class="status-badge passive-search">üîç Recherche logement PASSIVE</span>
                        {% endif %}
                        {% if user_data.user.recherche_locataire_status == 'active' %}
                            <span class="status-badge active-search">üë§ Recherche locataire ACTIVE</span>
                        {% elif user_data.user.recherche_locataire_status == 'passive' %}
                            <span class="status-badge passive-search">üë§ Recherche locataire PASSIVE</span>
                        {% endif %}
                        {% if user_data.user.disponibilite_rdv == 'disponible' %}
                            <span class="status-badge available">‚úÖ Disponible pour RDV</span>
                        {% elif user_data.user.disponibilite_rdv == 'occupe' %}
                            <span class="status-badge busy">‚è∏Ô∏è Occup√©</span>
                        {% elif user_data.user.disponibilite_rdv == 'bientot_disponible' %}
                            <span class="status-badge soon-available">‚è∞ Bient√¥t disponible</span>
                        {% endif %}
                    </div>
                    
                    <div class="user-stats">
                        <span>{{ user_data.connections_count }} connexions</span>
                        {% if user_data.user.is_proprietaire %}
                            <span>{{ user_data.user.logements.count }} biens</span>
                        {% endif %}
                    </div>
                </div>
                <div class="user-card-actions">
                    {% if user_data.is_connected %}
                        <span class="btn-connected">‚úì Connect√©</span>
                    {% else %}
                        <button class="btn-connect" onclick="sendConnectionRequest({{ user_data.user.id }})">
                            ü§ù Se connecter
                        </button>
                    {% endif %}
                    {% if user_data.is_following %}
                        <span class="btn-following">‚úì Suivi</span>
                    {% else %}
                        <button class="btn-follow" onclick="toggleFollow({{ user_data.user.id }})">
                            ‚ûï Suivre
                        </button>
                    {% endif %}
                    <button class="btn-invite" onclick="openInviteModal({{ user_data.user.id }}, '{{ user_data.user.username }}')">
                        ‚úâÔ∏è Inviter
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-results">
                <p>Aucun utilisateur trouv√©.</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="page-link">‚Üê Pr√©c√©dent</a>
            {% endif %}
            <span class="page-info">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="page-link">Suivant ‚Üí</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Mini-carte profil popup -->
<div id="profile-popup" class="profile-popup" style="display: none;">
    <div class="popup-content">
        <div class="popup-header">
            <div class="popup-avatar" id="popup-avatar"></div>
            <div class="popup-info">
                <h4 id="popup-name"></h4>
                <p id="popup-username"></p>
            </div>
        </div>
        <div class="popup-body">
            <p id="popup-bio"></p>
            <div id="popup-stats"></div>
            <div id="popup-status"></div>
        </div>
        <div class="popup-actions">
            <a href="#" id="popup-profile-link" class="btn-view-profile">Voir le profil</a>
            <button class="btn-connect-popup" id="popup-connect-btn">Se connecter</button>
        </div>
    </div>
</div>

<!-- Modal invitation personnalis√©e -->
<div id="invite-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="closeInviteModal()">&times;</span>
        <h3>Envoyer une invitation personnalis√©e</h3>
        <form id="invite-form" onsubmit="sendInvitation(event)">
            <input type="hidden" id="invite-user-id" name="user_id">
            <div class="form-group">
                <label>√Ä</label>
                <input type="text" id="invite-username" readonly>
            </div>
            <div class="form-group">
                <label>Type d'invitation</label>
                <select id="invite-type" name="type_invitation">
                    <option value="connection">Demande de connexion</option>
                    <option value="group">Invitation √† un groupe</option>
                    <option value="event">Invitation √† un √©v√©nement</option>
                    <option value="collaboration">Invitation √† collaborer</option>
                    <option value="other">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label>Message personnalis√© (optionnel)</label>
                <textarea id="invite-message" name="message_personnalise" rows="4" placeholder="Ajoutez un message personnalis√©..."></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="invite-grouped" name="est_recommandation_group√©e">
                    Recommandation group√©e (inviter avec d'autres utilisateurs)
                </label>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeInviteModal()">Annuler</button>
                <button type="submit">Envoyer l'invitation</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Styles pour la recherche d'utilisateurs */
.user-search-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

.search-header {
    text-align: center;
    margin-bottom: 32px;
}

.search-header h1 {
    font-size: 32px;
    margin-bottom: 8px;
}

.search-subtitle {
    color: #666;
    font-size: 16px;
}

.search-bar-main {
    margin-bottom: 32px;
}

.search-input-wrapper {
    display: flex;
    gap: 12px;
    max-width: 800px;
    margin: 0 auto;
}

.search-input {
    flex: 1;
    padding: 14px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
}

.search-input:focus {
    outline: none;
    border-color: #D3580B;
}

.search-btn {
    padding: 14px 32px;
    background: #D3580B;
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    font-size: 16px;
}

.smart-filters-section {
    margin-bottom: 32px;
}

.smart-filters-section h3 {
    margin-bottom: 16px;
    font-size: 20px;
}

.smart-filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

.smart-filter-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.smart-filter-btn:hover {
    border-color: #D3580B;
    transform: translateY(-2px);
}

.smart-filter-btn.active {
    background: #D3580B;
    color: white;
    border-color: #D3580B;
}

.filter-icon {
    font-size: 24px;
}

.filter-label {
    font-weight: 600;
    font-size: 14px;
}

.filter-count {
    font-size: 12px;
    opacity: 0.8;
}

.advanced-filters-section {
    margin-bottom: 24px;
}

.toggle-filters-btn {
    width: 100%;
    padding: 12px;
    background: #f5f5f5;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.advanced-filters-content {
    margin-top: 16px;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 12px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
}

.filter-group input,
.filter-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
}

.suggestions-ia-section {
    margin-bottom: 32px;
    padding: 24px;
    background: linear-gradient(135deg, rgba(211, 88, 11, 0.05) 0%, rgba(196, 81, 10, 0.05) 100%);
    border-radius: 16px;
}

.suggestions-ia-section h3 {
    margin-bottom: 20px;
    font-size: 20px;
}

.suggestions-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
}

.suggestion-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
}

.suggestion-header {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}

.suggestion-user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.suggestion-user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.suggestion-info h4 {
    margin: 0 0 4px 0;
    font-size: 16px;
}

.suggestion-type {
    font-size: 12px;
    color: #666;
    margin: 0;
}

.suggestion-score {
    font-size: 12px;
    color: #D3580B;
    font-weight: 600;
    margin: 0;
}

.suggestion-reasons {
    margin: 12px 0;
    font-size: 13px;
}

.suggestion-reasons ul {
    margin: 8px 0 0 0;
    padding-left: 20px;
}

.suggestion-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.results-section {
    margin-top: 32px;
}

.results-section h3 {
    margin-bottom: 20px;
    font-size: 20px;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.user-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s;
    position: relative;
}

.user-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.user-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.user-avatar {
    position: relative;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: #D3580B;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 600;
}

.online-status {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid white;
}

.online-status.online {
    background: #4CAF50;
}

.online-status.offline {
    background: #ccc;
}

.user-badges {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.badge.verified {
    background: #4CAF50;
    color: white;
}

.badge.identity {
    background: #2196F3;
    color: white;
}

.user-card-body h4 {
    margin: 0 0 4px 0;
    font-size: 18px;
}

.user-card-body h4 a {
    color: #1a1a1a;
    text-decoration: none;
}

.user-username {
    color: #666;
    font-size: 14px;
    margin: 0 0 8px 0;
}

.user-profession {
    font-size: 14px;
    color: #333;
    margin: 0 0 4px 0;
}

.user-location {
    font-size: 13px;
    color: #666;
    margin: 0 0 12px 0;
}

.user-status-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 12px;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.status-badge.active-search {
    background: #4CAF50;
    color: white;
}

.status-badge.passive-search {
    background: #FFC107;
    color: #333;
}

.status-badge.available {
    background: #4CAF50;
    color: white;
}

.status-badge.busy {
    background: #f44336;
    color: white;
}

.status-badge.soon-available {
    background: #FF9800;
    color: white;
}

.user-stats {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: #666;
    margin-bottom: 12px;
}

.user-card-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-connect, .btn-follow, .btn-invite {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-connect {
    background: #D3580B;
    color: white;
}

.btn-connect:hover {
    background: #c4510a;
}

.btn-follow {
    background: #f5f5f5;
    color: #333;
}

.btn-follow:hover {
    background: #e0e0e0;
}

.btn-invite {
    background: #2196F3;
    color: white;
}

.btn-invite:hover {
    background: #1976D2;
}

.btn-connected, .btn-following {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    background: #4CAF50;
    color: white;
}

/* Profile Popup */
.profile-popup {
    position: fixed;
    z-index: 10000;
    pointer-events: none;
}

.popup-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    padding: 20px;
    min-width: 300px;
    max-width: 400px;
    pointer-events: auto;
}

.popup-header {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.popup-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.popup-info h4 {
    margin: 0 0 4px 0;
    font-size: 16px;
}

.popup-info p {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.popup-body {
    margin-bottom: 16px;
}

.popup-body p {
    font-size: 14px;
    color: #333;
    margin: 0 0 12px 0;
}

.popup-actions {
    display: flex;
    gap: 8px;
}

.btn-view-profile, .btn-connect-popup {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-view-profile {
    background: #D3580B;
    color: white;
}

.btn-connect-popup {
    background: #f5f5f5;
    color: #333;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}

.close-modal {
    position: absolute;
    top: 16px;
    right: 16px;
    font-size: 28px;
    cursor: pointer;
    color: #666;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

.form-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}

.form-actions button[type="submit"] {
    background: #D3580B;
    color: white;
}

.form-actions button[type="button"] {
    background: #f5f5f5;
    color: #333;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-top: 32px;
}

.page-link {
    padding: 8px 16px;
    background: #D3580B;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
}

.page-info {
    color: #666;
}

.empty-results {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}
</style>

<script>
// Fonctions JavaScript pour la recherche
let profilePopupTimeout;

function applyFilter(filterName, filterValue) {
    const url = new URL(window.location.href);
    if (filterValue) {
        url.searchParams.set(filterName, filterValue);
    } else {
        url.searchParams.delete(filterName);
    }
    url.searchParams.delete('page'); // Reset pagination
    window.location.href = url.toString();
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advanced-filters');
    const icon = document.querySelector('.toggle-icon');
    if (filters.style.display === 'none') {
        filters.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        filters.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Mini-carte profil popup
function showProfilePopup(event, userId) {
    clearTimeout(profilePopupTimeout);
    
    profilePopupTimeout = setTimeout(() => {
        fetch(`{% url 'api-user-popup' user_id=0 %}`.replace('0', userId))
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const popup = document.getElementById('profile-popup');
                    const user = data.user;
                    
                    // Avatar
                    const avatarEl = document.getElementById('popup-avatar');
                    if (user.avatar) {
                        avatarEl.innerHTML = `<img src="${user.avatar}" alt="${user.username}">`;
                    } else {
                        avatarEl.innerHTML = `<div class="avatar-placeholder">${user.username[0].toUpperCase()}</div>`;
                    }
                    
                    // Infos
                    document.getElementById('popup-name').textContent = user.full_name || user.username;
                    document.getElementById('popup-username').textContent = '@' + user.username;
                    document.getElementById('popup-bio').textContent = user.bio || 'Aucune bio disponible.';
                    
                    // Stats
                    const statsEl = document.getElementById('popup-stats');
                    statsEl.innerHTML = `
                        <p><strong>${user.connections_count}</strong> connexions</p>
                        ${user.is_proprietaire ? `<p><strong>${user.logements_count}</strong> biens</p>` : ''}
                    `;
                    
                    // Status
                    const statusEl = document.getElementById('popup-status');
                    let statusHTML = '';
                    if (user.recherche_logement_status === 'active') {
                        statusHTML += '<span class="status-badge active-search">üîç Recherche ACTIVE</span>';
                    }
                    if (user.disponibilite_rdv === 'disponible') {
                        statusHTML += '<span class="status-badge available">‚úÖ Disponible</span>';
                    }
                    statusEl.innerHTML = statusHTML;
                    
                    // Actions
                    document.getElementById('popup-profile-link').href = `/profile/${userId}/`;
                    document.getElementById('popup-connect-btn').onclick = () => sendConnectionRequest(userId);
                    
                    // Position
                    popup.style.display = 'block';
                    const rect = event.target.closest('.user-card, .suggestion-card').getBoundingClientRect();
                    popup.style.left = (rect.right + 20) + 'px';
                    popup.style.top = (rect.top + window.scrollY) + 'px';
                }
            })
            .catch(err => console.error('Erreur:', err));
    }, 500); // D√©lai de 500ms avant d'afficher
}

function hideProfilePopup() {
    clearTimeout(profilePopupTimeout);
    setTimeout(() => {
        const popup = document.getElementById('profile-popup');
        popup.style.display = 'none';
    }, 200);
}

// Invitation personnalis√©e
function openInviteModal(userId, username) {
    document.getElementById('invite-user-id').value = userId;
    document.getElementById('invite-username').value = username;
    document.getElementById('invite-modal').style.display = 'flex';
}

function closeInviteModal() {
    document.getElementById('invite-modal').style.display = 'none';
    document.getElementById('invite-form').reset();
}

function sendInvitation(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {
        user_id: formData.get('user_id'),
        type_invitation: formData.get('type_invitation'),
        message_personnalise: formData.get('message_personnalise'),
        est_recommandation_group√©e: formData.get('est_recommandation_group√©e') === 'on',
    };
    
    fetch('/api/connect/users/invite/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Invitation envoy√©e avec succ√®s !');
            closeInviteModal();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Connexion
function sendConnectionRequest(userId) {
    fetch(`/connect/users/${userId}/connect/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Demande de connexion envoy√©e !');
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Follow
function toggleFollow(userId) {
    fetch(`/connect/users/${userId}/follow/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Helper CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Scroll infini (√† impl√©menter si n√©cessaire)
let isLoading = false;
window.addEventListener('scroll', () => {
    if (isLoading) return;
    
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
        // Charger plus de r√©sultats
        const nextPage = {{ page_obj.number|add:1 }};
        if (nextPage <= {{ page_obj.paginator.num_pages }}) {
            isLoading = true;
            // TODO: Impl√©menter le chargement AJAX
        }
    }
});
</script>
{% endblock %}

