<!-- Onglet Entretien & Travaux -->
<div class="tab-section">
    <h2 class="section-title">Signaler un problème</h2>
    
    <form action="{% url 'create-maintenance-request' %}" method="post" enctype="multipart/form-data" class="maintenance-form">
        {% csrf_token %}
        <input type="hidden" name="bail_id" value="{{ bail.id }}">
        
        <div class="form-group">
            <label for="id_type_probleme">Type de problème <span class="required">*</span></label>
            <select id="id_type_probleme" name="type_probleme" required>
                <option value="">Sélectionnez un type</option>
                <option value="plomberie">Plomberie</option>
                <option value="electricite">Électricité</option>
                <option value="chauffage">Chauffage</option>
                <option value="climatisation">Climatisation</option>
                <option value="peinture">Peinture</option>
                <option value="vitrerie">Vitrerie</option>
                <option value="porte_fenetre">Porte/Fenêtre</option>
                <option value="isolation">Isolation</option>
                <option value="sanitaire">Sanitaire</option>
                <option value="autre">Autre</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="id_titre">Titre de la demande <span class="required">*</span></label>
            <input type="text" id="id_titre" name="titre" required placeholder="Ex: Fuite d'eau dans la salle de bain" maxlength="200">
        </div>
        
        <div class="form-group">
            <label for="id_description">Description détaillée <span class="required">*</span></label>
            <textarea id="id_description" name="description" rows="5" required placeholder="Décrivez le problème en détail..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="id_photos">Photos (max 5)</label>
            <input type="file" id="id_photos" name="photos" multiple accept="image/*">
            <small class="form-help">Vous pouvez ajouter jusqu'à 5 photos pour illustrer le problème.</small>
        </div>
        
        <div class="form-group">
            <label for="id_urgence">Niveau d'urgence <span class="required">*</span></label>
            <select id="id_urgence" name="urgence" required>
                <option value="urgent">Urgent - Intervention nécessaire rapidement</option>
                <option value="normal" selected>Normal - Intervention dans les délais normaux</option>
                <option value="faible">Faible - Peut attendre</option>
            </select>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                Envoyer au propriétaire
            </button>
        </div>
    </form>

    <h2 class="section-title mt-4">Historique des demandes</h2>
    
    {% if tab_data.demandes_entretien %}
    <div class="maintenance-requests-list">
        {% for demande in tab_data.demandes_entretien %}
        <div class="request-card status-{{ demande.statut }}">
            <div class="request-header">
                <div class="request-type-badge type-{{ demande.type_probleme }}">
                    {{ demande.get_type_probleme_display }}
                </div>
                <div class="request-urgency urgency-{{ demande.urgence }}">
                    {% if demande.urgence == 'urgent' %}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        Urgent
                    {% elif demande.urgence == 'normal' %}
                        Normal
                    {% else %}
                        Faible
                    {% endif %}
                </div>
            </div>
            
            <div class="request-title">{{ demande.titre }}</div>
            <div class="request-description">{{ demande.description|linebreaks }}</div>
            
            {% if demande.photos.all %}
            <div class="request-photos">
                {% for photo in demande.photos.all %}
                <a href="{{ photo.image.url }}" target="_blank" class="request-photo-item">
                    <img src="{{ photo.image.url }}" alt="Photo {{ forloop.counter }}">
                </a>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="request-footer">
                <div class="request-date">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    {{ demande.created_at|date:"d/m/Y à H:i" }}
                </div>
                <div class="request-status">
                    <span class="status-badge status-{{ demande.statut }}">
                        {{ demande.get_statut_display }}
                    </span>
                </div>
            </div>
            
            {% if demande.reponse_proprietaire %}
            <div class="owner-reply">
                <div class="owner-reply-header">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Réponse du propriétaire
                </div>
                <div class="owner-reply-content">{{ demande.reponse_proprietaire|linebreaks }}</div>
                {% if demande.date_reponse %}
                <div class="owner-reply-date">Le {{ demande.date_reponse|date:"d/m/Y à H:i" }}</div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
        </svg>
        <p>Aucune demande d'entretien enregistrée.</p>
    </div>
    {% endif %}
</div>

<style>
    .maintenance-form {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
    }

    .required {
        color: #dc3545;
    }

    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }

    .form-group input[type="text"]:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #D3580B;
        box-shadow: 0 0 0 3px rgba(211, 88, 11, 0.1);
    }

    .form-group textarea {
        resize: vertical;
    }

    .form-group input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 2px dashed #e5e5e5;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-group input[type="file"]:hover {
        border-color: #D3580B;
        background: #fff5f0;
    }

    .form-help {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: #666;
    }

    .form-actions {
        margin-top: 24px;
        display: flex;
        justify-content: flex-end;
    }

    .btn-primary {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: #D3580B;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background: #c4510a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(211, 88, 11, 0.3);
    }

    /* Historique demandes */
    .maintenance-requests-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .request-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s ease;
    }

    .request-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .request-card.status-en_attente {
        border-color: #ffc107;
    }

    .request-card.status-en_cours {
        border-color: #007bff;
    }

    .request-card.status-resolu {
        border-color: #28a745;
    }

    .request-card.status-refuse {
        border-color: #dc3545;
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .request-type-badge {
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        background: #e9ecef;
        color: #495057;
    }

    .request-urgency {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .request-urgency.urgency-urgent {
        background: #f8d7da;
        color: #721c24;
    }

    .request-urgency.urgency-normal {
        background: #d1ecf1;
        color: #0c5460;
    }

    .request-urgency.urgency-faible {
        background: #d4edda;
        color: #155724;
    }

    .request-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 12px;
    }

    .request-description {
        font-size: 14px;
        color: #333;
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .request-photos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }

    .request-photo-item {
        width: 100%;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .request-photo-item:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .request-photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .request-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        border-top: 1px solid #e5e5e5;
    }

    .request-date {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #999;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.status-en_attente {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.status-en_cours {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-badge.status-resolu {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.status-refuse {
        background: #f8d7da;
        color: #721c24;
    }

    .owner-reply {
        margin-top: 20px;
        padding: 16px;
        background: #e7f3ff;
        border-radius: 8px;
        border-left: 3px solid #007bff;
    }

    .owner-reply-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 12px;
    }

    .owner-reply-content {
        font-size: 14px;
        color: #333;
        line-height: 1.6;
        margin-bottom: 8px;
    }

    .owner-reply-date {
        font-size: 12px;
        color: #666;
    }

    .empty-state {
        text-align: center;
        padding: 60px 24px;
        color: #999;
    }

    .empty-state svg {
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state p {
        margin: 0;
        font-size: 16px;
    }
</style>

